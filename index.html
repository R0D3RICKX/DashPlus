<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inter‑Company Scan Demo</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f8fafc;
      color: #0f172a;
    }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    input[type="text"] {
      flex: 1 1 200px;
      padding: 0.5rem 0.75rem;
      border: 1px solid #cbd5e1;
      border-radius: 0.375rem;
      font-size: 1rem;
    }
    button {
      padding: 0.5rem 1.25rem;
      border: none;
      border-radius: 0.375rem;
      background: #2563eb;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #status { margin-bottom: 1rem; font-weight: 500; }
    #analysis {
      white-space: pre-wrap;
      background: #ffffff;
      padding: 1rem;
      border-radius: 0.375rem;
      border: 1px solid #e2e8f0;
      max-height: 40vh;
      overflow: auto;
    }
    .file-list { margin-top: 1rem; }
    .file-list h2 { font-size: 1.125rem; margin: 1.5rem 0 0.5rem; }
    .file-list ul { list-style: none; padding: 0; }
    .file-list li { margin: 0.25rem 0; }
    .file-list a {
      color: #2563eb;
      text-decoration: none;
    }
    .file-list a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>Inter‑Company Scan API Tester</h1>
  <form id="scanForm" onsubmit="event.preventDefault(); runScan();">
    <input id="groupName" type="text" placeholder="Enter parent group name (e.g., Diageo)" required />
    <button id="submitBtn" type="submit">Scan</button>
  </form>
  <div id="status"></div>
  <div id="analysis"></div>
  <div id="downloads" class="file-list"></div>

<script>
async function runScan() {
  const group = document.getElementById('groupName').value.trim();
  const statusEl = document.getElementById('status');
  const analysisEl = document.getElementById('analysis');
  const dlEl = document.getElementById('downloads');
  const btn = document.getElementById('submitBtn');

  if (!group) return;
  statusEl.textContent = '⏳ Sending request…';
  analysisEl.textContent = '';
  dlEl.innerHTML = '';
  btn.disabled = true;

  try {
    const res = await fetch('https://newapi-pied.vercel.app/api/scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ group_name: group })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || res.statusText);
    }

    const data = await res.json();
    statusEl.textContent = '✅ Success';
    analysisEl.textContent = data.analysis_text || 'No analysis text returned.';

    // Helper to create download links from base64 PDFs
    function listFiles(arr, title) {
      if (!Array.isArray(arr) || !arr.length) return;
      const section = document.createElement('section');
      const h2 = document.createElement('h2');
      h2.textContent = title;
      section.appendChild(h2);
      const ul = document.createElement('ul');
      arr.forEach(f => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        const fname = f.filename || `${title}_${f.part || ''}.pdf`;
        a.textContent = `Download ${fname}`;
        a.href = `data:application/pdf;base64,${f.pdf_base64}`;
        a.download = fname;
        li.appendChild(a);
        ul.appendChild(li);
      });
      section.appendChild(ul);
      dlEl.appendChild(section);
    }

    listFiles(data.combined_pdfs, 'Combined PDFs');
    listFiles(data.raw_files, 'Raw PDFs');

  } catch (err) {
    statusEl.textContent = '❌ ' + err.message;
  } finally {
    btn.disabled = false;
  }
}
</script>
</body>
</html>
